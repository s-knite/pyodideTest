<!doctype html>
<html>
  <head>
      <script src="https://cdn.jsdelivr.net/pyodide/v0.28.3/full/pyodide.js"></script>
	  <style>
		html {
		  height: 100%;
		}
		body {
		  padding: 0;
		  margin: 0;
		  display: flex;
		  flex-direction: column;
		  height: 100%;
		}

		.nav {
		  width: 100%;
		  min-height: 50px;
		  background: navy;
		  font-family: Arial, Sans-serif;
		  color: white;
		  text-align: right;
		  padding: 10px 20px;
		  box-sizing: border-box;
		}
		.nav h1 {
		  margin: 0;
		}

		.main {
		  display: flex;
		  flex-grow:1;
		}
		.main div {
		  flex-basis: 50%;
		}
		.left {
		  background-color: lightgrey;
		  
		  justify-content: center;
		}
		.right {
		  background-color: coral;
		}

		.ðŸ’ªcenter {
		  display: flex;
		  align-items: center;
		  justify-content: center;
		  flex-direction: column;
		}
		#codeWindow {
		  font-family: monospace;
		  resize: none;
		  outline: none;
		}
		#loader {
			font-weight: bold;
			flex-grow: 0;
			flex-basis: 0;
			}
		#instructions {
			flex-basis: 0;
			flex-grow: 0;
			margin-bottom: 20px;
		}
	  </style>

  </head>
  <body>
	<div class="nav">
	  <h1>POCC</h1>
	</div>
	<div class="main">
	  <div class="left ðŸ’ªcenter">
		<div id="loader">Loading Python runtime... Please wait.</div>
		<button id="testsButton" disabled>Run Tests</button>
		<pre id="resultsWindow"></pre>
	  </div>
	  <div class="right ðŸ’ªcenter">
		<div id="instructions">
			<ul>
				<li>Create a variable called greeting with the value Hello</li>
				<li>Create a function called greet which takes in a name and says "Hello, [name]!" with the name given</li>
				<li>Create a function called add which takes two numbers and returns the sum</li>
			</ul>
		</div>
		<textarea name="code-window" id="codeWindow" cols="80" rows="20" placeholder="Enter your code here" wrap="off"></textarea>
	  </div>

	</div>
  </body>
  <script>
	const codeInput = document.getElementById('codeWindow');
	const runButton = document.getElementById('testsButton');
	const resultsOutput = document.getElementById('resultsWindow');
	const loader = document.getElementById('loader');

	// The new, more comprehensive testCode string
	const testCode = `
	import sys
	import io
	import inspect
	from contextlib import redirect_stdout

	class TestRunner:
		def __init__(self,total):
			self.results = []
			self.passed = 0
			self.total = total
			self.count = 0

		def run_test(self, description, success):
			self.count += 1
			if success:
				self.passed += 1
				self.results.append(f"âœ… PASSED: {description}")
			else:
				self.results.append(f"âŒ FAILED: {description}")

		def check_variable_exists(self, name, quiet = False):
			exists = name in globals()
			if not quiet:
				self.run_test(f"Variable '{name}' exists.", exists)
			return exists

		def check_variable_value(self, name, expected_value):
			if self.check_variable_exists(name, True):
				value = globals()[name]
				self.run_test(f"Variable '{name}' has value '{expected_value}'.", value == expected_value)

		def check_function_exists(self, name, quiet = False):
			exists = name in globals() and callable(globals().get(name))
			if not quiet:
				self.run_test(f"Function '{name}' exists.", exists)
			return exists

		def check_function_parameters(self, name, expected_count):
			if self.check_function_exists(name, True):
				func = globals()[name]
				sig = inspect.signature(func)
				param_count = len(sig.parameters)
				self.run_test(f"Function '{name}' has {expected_count} parameter(s).", param_count == expected_count)

		def check_function_prints(self, name, args, expected_print):
			if self.check_function_exists(name,True):
				func = globals()[name]
				f = io.StringIO()
				with redirect_stdout(f):
					func(*args)
				printed_output = f.getvalue().strip()
				self.run_test(f"Function '{name}' prints '{expected_print}'.", printed_output == expected_print)

		def check_function_returns(self, name, args, expected_return):
			if self.check_function_exists(name,True):
				func = globals()[name]
				return_value = func(*args)
				self.run_test(f"Function '{name}' returns '{expected_return}'.", return_value == expected_return)

		def format_results(self):
			summary = f"--- Results: {self.passed}/{self.total} tests passed ---\\n"
			if self.count != self.total:
				summary += f"Could not run all tests - {self.count} test(s) completed\\n"
			details = "\\n".join(self.results)
			return summary + details

	# --- Main Test Execution ---
	runner = TestRunner(9)
	try:
		# 1. Test the GREETING variable
		runner.check_variable_exists('greeting')
		runner.check_variable_value('greeting', 'Hello')

		# 2. Test the greet(name) function
		runner.check_function_exists('greet')
		runner.check_function_parameters('greet', 1)
		runner.check_function_prints('greet', args=('Ada',), expected_print='Hello, Ada!')
		
		# 3. Test the add(a, b) function
		runner.check_function_exists('add')
		runner.check_function_parameters('add', 2)
		runner.check_function_returns('add', args=(5, 3), expected_return=8)
		runner.check_function_returns('add', args=(-5, 3), expected_return=-2)

	except Exception as e:
		runner.results.append(f"\\nCRITICAL ERROR: An error occurred during testing: {e}")

	# This final expression is returned to JavaScript
	runner.format_results()
	`;

	async function setupPyodide() {
		let pyodide = await loadPyodide();
		loader.textContent = 'Python runtime loaded! Ready to run code.';
		runButton.disabled = false;
		return pyodide;
	}

	const pyodidePromise = setupPyodide();

	runButton.addEventListener('click', async () => {
		const pyodide = await pyodidePromise;
		const userCode = codeInput.value;
		resultsOutput.textContent = 'Running tests...';
		
		
		let output = '';
		
		try {
			// Run the user's code to make their function available
			pyodide.runPython(userCode);
			
			// Assign the captured string to the 'output' variable
			output = pyodide.runPython(testCode);

		} catch (error) {
			// This will catch syntax errors in the user's code
			output = "Code would not run - please test in an IDE";
		}
		
		// Now 'output' is accessible here and can be displayed
		resultsOutput.textContent = output;
	});
</script>
</html>
